<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Panel de Control ‚Äî Latam5S</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuraci√≥n de Tailwind para usar colores y fuentes personalizados
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'accent': '#D96B4F', // El color principal (Terracota)
                        'accent-alt': '#FF8B6A', // El color secundario (Naranja claro)
                        'bg-soft': '#fffaf6', // El color de fondo original
                        'badge-pending': '#9a6200',
                        'badge-sent': '#D96B4F',
                        'badge-delivered': '#1b7f3a',
                        'badge-rescheduled': '#8e44ad',
                        // Se a√±ade 'brand-accent' para que coincida con la clase del h√©roe
                        'brand-accent': '#D96B4F', 
                    },
                    fontFamily: {
                        sans: ['Quicksand', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'],
                    },
                    borderRadius: {
                        'xl': '14px', // Mantenemos el radio de borde original
                    }
                },
            }
        }
    </script>
    <style>
        /* Estilos base (M√≠nimo CSS necesario) */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { background-color: #fffaf6; color: #2b2b2b; line-height: 1.6; }

        /* Clases de utilidad */
        .oculto { display: none !important; }

        /* Manejo de secciones (ya no lo hace el CSS, sino el JS que a√±ade 'active') */
        main > section { display: none; }
        main > section.active { display: block; }

        /* Estilos espec√≠ficos para la tabla (para manejar el nowrap y el ancho) */
        .nowrap { white-space: nowrap; }

        /* Animaci√≥n para el panel de edici√≥n */
        #editPanel {
            transition: transform 0.3s ease-in-out;
        }

        /* Estilos para la impresi√≥n de etiquetas */
        @media print {
            body > * { display: none; } /* Oculta todo por defecto */
            .print-container { 
                display: block; 
                width: 100%;
                /* Ajustes para un formato de etiqueta com√∫n, por ejemplo 4x6 pulgadas o similar a un A4, usando CSS columns */
                column-count: 2; 
                column-gap: 1.5cm;
                padding: 1cm;
            }
            .label-card {
                /* Esto asegura que la tarjeta de etiqueta no se corte a trav√©s de la columna */
                break-inside: avoid-column; 
                page-break-inside: avoid;
                margin-bottom: 1.5cm; /* Espacio entre etiquetas */
                border: 1px solid #000;
                padding: 10px;
                width: 100%; /* Ocupa el ancho de la columna */
                min-height: 100px;
            }
            .label-header {
                font-size: 14px;
                font-weight: bold;
                border-bottom: 1px dashed #000;
                padding-bottom: 5px;
                margin-bottom: 5px;
            }
            .label-info {
                font-size: 12px;
                margin-top: 5px;
            }
            .qr-placeholder {
                text-align: center;
                margin-top: 10px;
                font-size: 10px;
                border: 1px solid #ccc;
                padding: 5px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }
    </style>
</head>
<body class="font-sans bg-bg-soft text-gray-900 antialiased">
    <!-- ---------- HEADER ---------- -->
    <header class="bg-gradient-to-br from-brand-accent to-orange-400 text-white p-6 shadow-xl shadow-accent/25 flex items-center justify-center md:justify-start gap-4">
        <img id="headerLogo" src="" alt="Logo Emprendimiento" class="h-12 w-12 rounded-lg object-cover bg-white p-1 hidden">
        <div>
            <h1 id="headerTitle" class="text-2xl font-bold">üìã Panel de Control</h1>
            <p class="mt-1 text-sm opacity-90">Bienvenido, <strong id="headerBusinessName">[Nombre del emprendimiento]</strong></p>
        </div>
    </header>

    <!-- ---------- NAV ---------- -->
    <nav class="bg-white/80 backdrop-blur-sm border-b border-gray-200 flex flex-wrap gap-1 p-3 sticky top-0 z-10 justify-center">
        <a href="#envios" class="nav-link active text-gray-500 font-semibold text-sm transition-colors p-2.5 rounded-lg flex items-center gap-1.5 
            hover:text-gray-900 w-full justify-center sm:w-auto 
            active:bg-orange-100 active:text-accent sm:active:text-accent">
            <i data-feather="truck" class="w-4 h-4"></i>Env√≠os
        </a>
        <a href="#link" class="nav-link text-gray-500 font-semibold text-sm transition-colors p-2.5 rounded-lg flex items-center gap-1.5 
            hover:text-gray-900 w-full justify-center sm:w-auto">
            <i data-feather="link" class="w-4 h-4"></i>Link M√°gico
        </a>
        <a href="#reportes" class="nav-link text-gray-500 font-semibold text-sm transition-colors p-2.5 rounded-lg flex items-center gap-1.5 
            hover:text-gray-900 w-full justify-center sm:w-auto">
            <i data-feather="bar-chart-2" class="w-4 h-4"></i>Reportes
        </a>
        <a href="#cuenta" class="nav-link text-gray-500 font-semibold text-sm transition-colors p-2.5 rounded-lg flex items-center gap-1.5 
            hover:text-gray-900 w-full justify-center sm:w-auto">
            <i data-feather="settings" class="w-4 h-4"></i>Mi Cuenta
        </a>
    </nav>

    <main class="p-6">
        
        <!-- ======================= SECCI√ìN ENV√çOS ======================= -->
        <section class="active" id="envios">
            <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200 mb-6">
                <h2 class="text-2xl font-bold text-accent mb-4 flex items-center gap-2">
                    <i data-feather="truck" class="w-6 h-6"></i>Mis Env√≠os
                </h2>
                
                <!-- Acciones Principales -->
                <div class="flex gap-2 flex-wrap justify-end mb-4">
                    <!-- Nuevo Bot√≥n para Plantilla DELIVERY -->
                    <button class="btn ghost bg-transparent border border-gray-200 text-gray-900 hover:bg-gray-50 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center gap-2" id="btnTplDelivery"><i data-feather="download" class="w-4 h-4"></i>Plantilla DELIVERY (.csv)</button>
                    <!-- Los otros botones se mantienen -->
                    <button class="btn ghost bg-transparent border border-gray-200 text-gray-900 hover:bg-gray-50 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center gap-2" id="btnTplShalom"><i data-feather="download" class="w-4 h-4"></i>Plantilla SHALOM (.csv)</button>
                    <button class="btn ghost bg-transparent border border-gray-200 text-gray-900 hover:bg-gray-50 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center gap-2" id="btnTplOlva"><i data-feather="download" class="w-4 h-4"></i>Plantilla OLVA (.csv)</button>
                    <button class="btn primary bg-gradient-to-r from-accent to-accent-alt text-white shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center gap-2" id="btnEtiquetas"><i data-feather="tag" class="w-4 h-4"></i>Imprimir Etiquetas</button>
                </div>
                
                <!-- Filtros -->
                <div class="flex flex-wrap items-center gap-3 my-4">
                    <label class="text-xs text-gray-500 font-semibold">Cliente (Celular)<input type="text" id="filtroCliente" placeholder="Ej: 987654321" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-40 text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100 mt-1" /></label>
                    <label class="text-xs text-gray-500 font-semibold">Fecha de Env√≠o<input type="date" id="filtroFecha" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-40 text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100 mt-1" /></label>
                    <label class="text-xs text-gray-500 font-semibold">Courier
                        <select id="filtroTipo" class="select p-2.5 border border-gray-200 rounded-xl bg-white w-40 text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100 mt-1">
                            <option value="">Todos</option>
                            <option value="DELIVERY">Delivery Propio</option>
                            <option value="SHALOM">Shalom</option>
                            <option value="OLVA">Olva</option>
                        </select>
                    </label>
                    <button class="btn primary bg-gradient-to-r from-accent to-accent-alt text-white py-2.5 px-4 rounded-xl font-bold text-sm h-fit self-end shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200" id="btnAplicarFiltros">Filtrar</button>
                </div>
                
                <!-- Lote y Selecci√≥n -->
                <div class="flex flex-wrap items-center justify-between gap-3 my-3">
                    <div class="lote-left flex gap-3 items-center flex-wrap">
                        <label class="nowrap text-sm text-gray-900"><input type="checkbox" id="checkTodos" class="rounded border-gray-300 text-accent focus:ring-accent" /> Seleccionar todo</label>
                        <span class="text-gray-500 text-sm" id="selCount">0 seleccionados</span>
                    </div>
                    <div class="lote-right flex gap-2 items-center flex-wrap justify-end">
                        <select id="accionLote" class="select p-2.5 border border-gray-200 rounded-xl bg-white w-auto text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
                            <option value="" selected>Acci√≥n en lote‚Ä¶</option>
                            <option value="ENVIADO">Marcar como Enviado</option>
                            <option value="ENTREGADO">Marcar como Entregado</option>
                            <option value="REPROGRAMADO">Reprogramar</option>
                            <option value="ELIMINAR" class="text-red-600 font-semibold">Eliminar Seleccionados</option>
                        </select>
                        <input type="date" id="fechaReprog" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-40 text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100 oculto" />
                        <button class="btn primary bg-accent text-white py-2.5 px-4 rounded-xl font-bold text-sm shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200" id="btnAplicarLote">Aplicar</button>
                    </div>
                </div>
                
                <!-- Contenedor de la Tabla -->
                <div id="tableContainer">
                    <div class="overflow-x-auto shadow-lg shadow-gray-100 rounded-xl border border-gray-200">
                        <table id="tablaEnvios" class="w-full border-collapse bg-white">
                            <thead>
                                <tr>
                                    <th class="border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50 rounded-tl-xl w-12"><input type="checkbox" id="thCheckTodos" class="rounded border-gray-300 text-accent focus:ring-accent" /></th>
                                    <th class="border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">Fecha Reg.</th>
                                    <th class="border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">Cliente</th>
                                    <th class="border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">Courier</th>
                                    <th class="border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">Destinatario</th>
                                    <th class="border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">Tel√©fono</th>
                                    <th class="col-distrito border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">Distrito</th>
                                    <th class="col-direccion border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">Direcci√≥n</th>
                                    <th class="col-referencia border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">Referencia</th>
                                    <th class="col-dni border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">DNI/CE</th>
                                    <th class="col-agencia border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">Agencia</th>
                                    <th class="border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">Fecha Env√≠o</th>
                                    <th class="border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50">Estado</th>
                                    <th class="border-t border-gray-200 p-3 text-left text-xs font-bold text-accent uppercase tracking-wider bg-orange-50 rounded-tr-xl">Notificar</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyEnvios">
                                <!-- JS llenar√° esta tabla -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Contenedor de Estado Vac√≠o (Onboarding) -->
                <div id="emptyStateContainer" class="hidden text-center p-10 border-2 border-dashed rounded-xl mt-4">
                    <i data-feather="gift" class="w-16 h-16 mx-auto text-gray-300"></i>
                    <h3 class="mt-4 text-xl font-bold text-gray-800">¬°Bienvenido a tu panel de control!</h3>
                    <p class="mt-2 text-sm text-gray-500 max-w-sm mx-auto">A√∫n no tienes env√≠os registrados. El primer paso es configurar tu 'Link M√°gico' y compartirlo con tus clientes.</p>
                    <button id="goToAccountBtn" class="mt-6 btn primary bg-gradient-to-r from-accent to-accent-alt text-white shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center gap-2">
                        <i data-feather="settings" class="w-4 h-4"></i> Ir a Configuraci√≥n
                    </button>
                </div>
            </div>
        </section>

        <!-- ======================= SECCI√ìN LINK M√ÅGICO ======================= -->
        <section id="link">
            <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200 mb-6">
                <h2 class="text-2xl font-bold text-accent mb-4 flex items-center gap-2">
                    <i data-feather="link" class="w-6 h-6"></i>Tu Enlace M√°gico
                </h2>
                <p class="text-gray-500 text-sm mb-5">Comparte este link √∫nico con tus clientes. Ellos completar√°n sus datos de env√≠o directamente y la informaci√≥n aparecer√° en tu panel, ¬°sin errores y sin que tengas que transcribir nada!</p>
                <div class="form-group">
                    <label for="linkUnicoInput" class="block text-sm text-gray-500 font-semibold mb-1.5">Tu enlace personal</label>
                    <div id="linkUnicoContainer" class="flex gap-2">
                        <input type="text" id="linkUnicoInput" class="input p-2.5 border border-gray-200 rounded-xl bg-gray-50 flex-grow text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" value="https://latam5s.com/form/tu-tienda" readonly>
                        <button class="btn primary bg-gradient-to-r from-accent to-accent-alt text-white shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center gap-2" id="btnCopiarLink"><i data-feather="copy" class="w-4 h-4"></i>Copiar</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- ======================= SECCI√ìN REPORTES ======================= -->
        <section id="reportes">
            <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200 mb-6">
                <h2 class="text-2xl font-bold text-accent mb-4 flex items-center gap-2">
                    <i data-feather="bar-chart-2" class="w-6 h-6"></i>Reportes (Este Mes)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                    <div class="stat-card text-center bg-bg-soft p-5 rounded-xl border border-orange-100">
                        <div class="value text-4xl font-bold text-accent" id="statTotal">128</div>
                        <div class="label text-sm text-gray-500 mt-1">Env√≠os Totales</div>
                    </div>
                    <div class="stat-card text-center bg-bg-soft p-5 rounded-xl border border-orange-100">
                        <div class="value text-4xl font-bold text-accent" id="statPendientes">15</div>
                        <div class="label text-sm text-gray-500 mt-1">Pendientes</div>
                    </div>
                    <div class="stat-card text-center bg-bg-soft p-5 rounded-xl border border-orange-100">
                        <div class="value text-4xl font-bold text-accent" id="statCompletados">113</div>
                        <div class="label text-sm text-gray-500 mt-1">Completados</div>
                    </div>
                    <div class="stat-card text-center bg-bg-soft p-5 rounded-xl border border-orange-100">
                        <div class="value text-2xl font-bold text-accent" id="statCourier">Shalom</div>
                        <div class="label text-sm text-gray-500 mt-1">Courier M√°s Usado</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ======================= SECCI√ìN MI CUENTA ======================= -->
        <section id="cuenta">
            <h2 class="text-2xl font-bold text-accent mb-4 flex items-center gap-2">
                <i data-feather="settings" class="w-6 h-6"></i>Configuraci√≥n de tu Cuenta
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                
                <!-- Columna Izquierda: Configuraciones Principales y Frecuentes -->
                <div class="lg:col-span-3 space-y-6">
                    <!-- Card: Perfil del Negocio -->
                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="briefcase" class="w-5 h-5 text-accent"></i> Perfil del Negocio</h3>
                        <div class="space-y-4">
                            <div class="form-group">
                                <label for="businessName" class="block text-sm text-gray-500 font-semibold mb-1.5">Nombre del Emprendimiento</label>
                                <input type="text" id="businessName" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="Ej: La Tiendita de Ana" value="Mi Tienda de Prueba">
                            </div>
                            <div class="form-group">
                                <label for="logoInput" class="block text-sm text-gray-500 font-semibold mb-1.5">Logo del Negocio</label>
                                <input type="file" id="logoInput" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm file:mr-4 file:py-1 file:px-2 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-accent hover:file:bg-orange-100" accept="image/*">
                                <img id="logoPreview" src="" alt="Vista previa del logo" class="max-h-20 rounded-lg object-contain border border-dashed border-gray-300 p-1 mt-3 hidden">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card: Opciones de Despacho -->
                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="calendar" class="w-5 h-5 text-accent"></i> Opciones de Despacho</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-3">
                                <label class="block text-sm text-gray-500 font-semibold">Couriers Habilitados</label>
                                <div class="space-y-2">
                                    <label class="block text-sm text-gray-900"><input type="checkbox" checked class="rounded border-gray-300 text-accent focus:ring-accent mr-2"> Delivery Propio</label>
                                    <label class="block text-sm text-gray-900"><input type="checkbox" checked class="rounded border-gray-300 text-accent focus:ring-accent mr-2"> Shalom</label>
                                    <label class="block text-sm text-gray-900"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-2"> Olva</label>
                                    <label class="block text-sm text-gray-900"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-2"> Dinsides</label>
                                </div>
                            </div>
                             <div class="space-y-3">
                                <label class="block text-sm text-gray-500 font-semibold">D√≠as de Despacho</label>
                                <div class="flex flex-wrap gap-x-4 gap-y-2 text-sm">
                                    <label class="inline-flex items-center"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Lun</label>
                                    <label class="inline-flex items-center"><input type="checkbox" checked class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Mar</label>
                                    <label class="inline-flex items-center"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Mi√©</label>
                                    <label class="inline-flex items-center"><input type="checkbox" checked class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Jue</label>
                                    <label class="inline-flex items-center"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Vie</label>
                                    <label class="inline-flex items-center"><input type="checkbox" checked class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> S√°b</label>
                                    <label class="inline-flex items-center"><input type="checkbox" class="rounded border-gray-300 text-accent focus:ring-accent mr-1"> Dom</label>
                                </div>
                            </div>
                            <div class="form-group md:col-span-2">
                                <label for="cutoffTime" class="block text-sm text-gray-500 font-semibold mb-1.5">Hora de Cierre de Pedidos</label>
                                <input type="time" id="cutoffTime" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full md:w-auto text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
                            </div>
                        </div>
                    </div>

                    <!-- Card: Redes Sociales -->
                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="share-2" class="w-5 h-5 text-accent"></i> Redes Sociales</h3>
                        <div class="space-y-4">
                            <p class="text-sm text-gray-500 -mt-2">Estos enlaces aparecer√°n en tu formulario para que tus clientes puedan contactarte.</p>
                            <div class="form-group">
                                <label for="instagramUser" class="block text-sm text-gray-500 font-semibold mb-1.5">Usuario de Instagram</label>
                                <div class="relative">
                                    <i data-feather="instagram" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                    <input type="text" id="instagramUser" class="input p-2.5 pl-9 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="mitiendaonline">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="whatsappNumber" class="block text-sm text-gray-500 font-semibold mb-1.5">N√∫mero de WhatsApp</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">+51</span>
                                    <input type="number" id="whatsappNumber" class="input p-2.5 pl-10 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="987654321">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="facebookUser" class="block text-sm text-gray-500 font-semibold mb-1.5">Usuario de Facebook</label>
                                <div class="relative">
                                    <i data-feather="facebook" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                    <input type="text" id="facebookUser" class="input p-2.5 pl-9 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="mitiendaonlinefb">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="tiktokUser" class="block text-sm text-gray-500 font-semibold mb-1.5">Usuario de TikTok</label>
                                <div class="relative">
                                    <i data-feather="music" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none"></i>
                                    <input type="text" id="tiktokUser" class="input p-2.5 pl-9 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="mitienda.tiktok">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha: Informaci√≥n de Cuenta y Funciones Avanzadas -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Card: Suscripci√≥n -->
                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="award" class="w-5 h-5 text-accent"></i> Tu Suscripci√≥n</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500">Plan Actual:</span>
                                <span class="font-bold text-gray-900">Crecimiento</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500">Estado:</span>
                                <span class="font-bold text-emerald-700 bg-emerald-100 px-2 py-0.5 rounded-full text-xs">Activo</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-500">Pr√≥ximo Pago:</span>
                                <span class="font-bold text-gray-900">15 Nov, 2025</span>
                            </div>
                            <div class="pt-2">
                                <button class="btn ghost bg-transparent border border-gray-200 text-gray-900 hover:bg-gray-50 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center gap-2 w-full justify-center">Administrar Suscripci√≥n</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card: Seguridad de la Cuenta -->
                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="lock" class="w-5 h-5 text-accent"></i> Seguridad de la Cuenta</h3>
                        <div class="space-y-4">
                            <div class="form-group">
                                <label for="userEmail" class="block text-sm text-gray-500 font-semibold mb-1.5">Email de la Cuenta</label>
                                <input type="email" id="userEmail" class="input p-2.5 border border-gray-200 rounded-xl bg-gray-100 w-full text-sm text-gray-600 cursor-not-allowed" value="ana.ventas@email.com" readonly>
                            </div>
                            <div class="form-group">
                                <label for="newPassword" class="block text-sm text-gray-500 font-semibold mb-1.5">Nueva Contrase√±a</label>
                                <input type="password" id="newPassword" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100" placeholder="Deja en blanco para no cambiar">
                            </div>
                        </div>
                    </div>

                    <!-- Card: Gesti√≥n de Equipo -->
                    <div class="card bg-white rounded-xl shadow-lg shadow-gray-100 p-6 border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 border-b border-gray-200 pb-3 mb-4"><i data-feather="users" class="w-5 h-5 text-accent"></i> Gesti√≥n de Equipo</h3>
                        <div class="space-y-4">
                            <p class="text-sm text-gray-500 -mt-2">Invita a miembros de tu equipo para que colaboren en la gesti√≥n de env√≠os (Funci√≥n del Plan Consolidado).</p>
                            <div class="flex gap-2">
                                <input type="email" placeholder="email@ejemplo.com" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100 flex-grow">
                                <button class="btn primary bg-accent text-white py-2.5 px-4 rounded-xl font-bold text-sm shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 whitespace-nowrap">Invitar</button>
                            </div>
                            <div class="space-y-2 pt-2">
                                <label class="block text-sm text-gray-500 font-semibold mb-1">Miembros Actuales:</label>
                                <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded-lg">
                                    <span>ana.ventas@email.com (T√∫)</span>
                                    <span class="font-bold text-accent">Admin</span>
                                </div>
                                <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded-lg">
                                    <span>carlos.logistica@email.com</span>
                                    <span class="text-gray-500">Miembro</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button class="btn primary bg-gradient-to-r from-accent to-accent-alt text-white shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm inline-flex items-center gap-2" id="btnGuardarConfig"><i data-feather="save" class="w-4 h-4"></i>Guardar Cambios</button>
            </div>
        </section>
        
        <!-- Footer -->
        <footer class="mt-20 pb-5 flex justify-center items-center gap-2 text-gray-500 text-sm">
            <span>Powered by</span>
            <svg height="20" viewBox="0 0 90 22" xmlns="http://www.w3.org/2000/svg">
                <text x="0" y="18" style="font-family: Quicksand, sans-serif; font-size: 20px; font-weight: 700; fill: #D96B4F;">Latam5S</text>
            </svg>
        </footer>
    </main>

    <!-- Toast de Notificaci√≥n -->
    <div class="toast fixed right-5 bottom-5 bg-gradient-to-r from-accent to-accent-alt text-white p-3 rounded-xl shadow-xl shadow-accent/25 opacity-0 translate-y-2 transition-all duration-300 z-50" id="toast">Acci√≥n aplicada</div>

    <!-- Modal de Confirmaci√≥n para Eliminar -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md text-center">
            <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0">
                <i data-feather="alert-triangle" class="h-6 w-6 text-red-600"></i>
            </div>
            <h3 class="text-lg leading-6 font-bold text-gray-900 mt-4" id="modal-title">
                Confirmar Eliminaci√≥n
            </h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500" id="modalMessage">
                    ¬øEst√°s seguro de que quieres eliminar los env√≠os seleccionados? Esta acci√≥n no se puede deshacer.
                </p>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                <button type="button" id="confirmDeleteBtn" class="inline-flex justify-center rounded-xl border border-transparent shadow-sm px-6 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Eliminar
                </button>
                <button type="button" id="cancelDeleteBtn" class="inline-flex justify-center rounded-xl border border-gray-300 shadow-sm px-6 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Panel Lateral de Edici√≥n -->
    <div id="editPanelOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden"></div>
    <aside id="editPanel" class="fixed top-0 right-0 h-full w-full max-w-md bg-bg-soft shadow-2xl transform translate-x-full z-30 flex flex-col">
        <div class="flex justify-between items-center p-4 border-b border-gray-200">
            <h2 class="text-lg font-bold text-accent flex items-center gap-2"><i data-feather="edit" class="w-5 h-5"></i>Editar Env√≠o</h2>
            <button id="closeEditPanel" class="p-2 rounded-full hover:bg-gray-200">
                <i data-feather="x" class="w-6 h-6 text-gray-600"></i>
            </button>
        </div>
        <form id="editForm" class="flex-grow p-6 space-y-4 overflow-y-auto">
            <input type="hidden" id="editShipmentId">
            <!-- Campos del formulario de edici√≥n -->
            <div class="form-group">
                <label for="editCliente" class="block text-sm text-gray-500 font-semibold mb-1.5">Celular del Cliente (No editable)</label>
                <input type="text" id="editCliente" class="input p-2.5 border border-gray-200 rounded-xl bg-gray-100 w-full text-sm text-gray-600 focus:outline-none focus:ring-0 focus:border-gray-200 cursor-not-allowed" readonly>
            </div>
            <div class="form-group">
                <label for="editNombre" class="block text-sm text-gray-500 font-semibold mb-1.5">Nombre del Destinatario</label>
                <input type="text" id="editNombre" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
            </div>
             <div class="form-group">
                <label for="editTelefono" class="block text-sm text-gray-500 font-semibold mb-1.5">Tel√©fono del Destinatario</label>
                <input type="text" id="editTelefono" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
            </div>
            <div class="form-group">
                <label for="editFechaEnvio" class="block text-sm text-gray-500 font-semibold mb-1.5">Fecha de Env√≠o</label>
                <input type="date" id="editFechaEnvio" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
            </div>

            <!-- Campos Condicionales -->
            <div id="editFieldsDelivery" class="space-y-4">
                <div class="form-group">
                    <label for="editDistrito" class="block text-sm text-gray-500 font-semibold mb-1.5">Distrito</label>
                    <input type="text" id="editDistrito" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
                </div>
                <div class="form-group">
                    <label for="editDireccion" class="block text-sm text-gray-500 font-semibold mb-1.5">Direcci√≥n</label>
                    <input type="text" id="editDireccion" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
                </div>
                <div class="form-group">
                    <label for="editReferencia" class="block text-sm text-gray-500 font-semibold mb-1.5">Referencia</label>
                    <input type="text" id="editReferencia" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
                </div>
            </div>

            <div id="editFieldsCourier" class="space-y-4">
                <div class="form-group">
                    <label for="editDni" class="block text-sm text-gray-500 font-semibold mb-1.5">DNI/CE</label>
                    <input type="text" id="editDni" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
                </div>
                <div class="form-group">
                    <label for="editAgencia" class="block text-sm text-gray-500 font-semibold mb-1.5">Agencia</label>
                    <input type="text" id="editAgencia" class="input p-2.5 border border-gray-200 rounded-xl bg-white w-full text-sm focus:outline-none focus:border-accent focus:ring-3 focus:ring-orange-100">
                </div>
            </div>
        </form>
        <div class="p-4 bg-white border-t border-gray-200 flex justify-end gap-3">
            <button type="button" id="cancelEditBtn" class="btn ghost bg-transparent border border-gray-200 text-gray-900 hover:bg-gray-50 transition-all duration-200 py-2.5 px-4 rounded-xl font-bold text-sm">Cancelar</button>
            <button type="button" id="saveEditBtn" class="btn primary bg-accent text-white py-2.5 px-4 rounded-xl font-bold text-sm shadow-md shadow-accent/20 hover:shadow-lg hover:shadow-accent/30 hover:-translate-y-0.5 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-md disabled:hover:-translate-y-0" disabled>Guardar Cambios</button>
        </div>
    </aside>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // Inicializa Feather Icons
    feather.replace();

    // --- VARIABLES GLOBALES DEL EMPRENDIMIENTO (SIMULADAS) ---
    // En una implementaci√≥n real con Firebase, estos vendr√≠an de un documento de configuraci√≥n.
    const businessName = document.getElementById('businessName').value || 'Mi Tienda de Prueba';

    // --- NAVEGACI√ìN PRINCIPAL ---
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('main > section');

    // Funci√≥n para manejar la navegaci√≥n entre secciones
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('href').substring(1);
            
            navLinks.forEach(l => {
                l.classList.remove('active', 'bg-orange-100', 'text-accent');
                l.classList.add('text-gray-500');
            });
            
            // Aplica clases de Tailwind para el estado activo
            link.classList.add('active', 'bg-orange-100', 'text-accent');
            link.classList.remove('text-gray-500');


            sections.forEach(sec => {
                sec.classList.toggle('active', sec.id === targetId);
            });
        });
    });

    // Inicializa la primera secci√≥n como activa visualmente
    document.querySelector('.nav-link.active').classList.add('bg-orange-100', 'text-accent');
    document.querySelector('.nav-link.active').classList.remove('text-gray-500');

    // --- SECCI√ìN ENV√çOS (Variables de DOM) ---
    const filtroTipo = document.getElementById('filtroTipo');
    const filtroCliente = document.getElementById('filtroCliente');
    const filtroFecha = document.getElementById('filtroFecha');
    const btnAplicarFiltros = document.getElementById('btnAplicarFiltros');
    const tbody = document.getElementById('tbodyEnvios');
    const checkTodos = document.getElementById('checkTodos');
    const thCheckTodos = document.getElementById('thCheckTodos');
    const selCount = document.getElementById('selCount');
    const accionLote = document.getElementById('accionLote');
    const fechaReprog = document.getElementById('fechaReprog');
    const btnAplicarLote = document.getElementById('btnAplicarLote');
    
    // Contenedores para la tabla y el estado vac√≠o
    const tableContainer = document.getElementById('tableContainer');
    const emptyStateContainer = document.getElementById('emptyStateContainer');
    const goToAccountBtn = document.getElementById('goToAccountBtn');
    
    // Botones de funciones nuevas
    const btnTplDelivery = document.getElementById('btnTplDelivery'); // Nuevo bot√≥n para Delivery
    const btnTplShalom = document.getElementById('btnTplShalom');
    const btnTplOlva = document.getElementById('btnTplOlva');
    const btnEtiquetas = document.getElementById('btnEtiquetas');

    // Datos de ejemplo (Simulaci√≥n de datos cargados desde Firestore)
    let sampleData = [
        { id: 1, tipo: "SHALOM", cliente: "912345678", fechaEnvio: "2025-08-20", fechaReg: "2025-08-18", nombre: "Mar√≠a L√≥pez", telefono: "912345678", dni: "87654321", agencia: "Lima / Lima / Chorrillos", estado: "ENVIADO" },
        { id: 2, tipo: "DELIVERY", cliente: "987654321", fechaEnvio: "2025-08-22", fechaReg: "2025-08-20", nombre: "Juan P√©rez", telefono: "999888777", distrito: "Miraflores", direccion: "Av. Principal 123", referencia: "Frente al parque", estado: "PENDIENTE" },
        { id: 3, tipo: "OLVA", cliente: "911223344", fechaEnvio: "2025-08-25", fechaReg: "2025-08-22", nombre: "Luc√≠a Guti√©rrez", telefono: "911223344", dni: "75342190", agencia: "Lima / Lima / Los Olivos", estado: "PENDIENTE" },
        { id: 4, tipo: "DELIVERY", cliente: "987111222", fechaEnvio: "2025-08-26", fechaReg: "2025-08-23", nombre: "Rosa Valdivia", telefono: "987111222", distrito: "San Miguel", direccion: "Av. Universitaria 240", referencia: "Al lado de la farmacia", estado: "ENTREGADO" },
        { id: 5, tipo: "SHALOM", cliente: "988667755", fechaEnvio: "2025-08-29", fechaReg: "2025-08-26", nombre: "Valeria Campos", telefono: "988667755", dni: "78451236", agencia: "Piura / Piura / Castilla", estado: "REPROGRAMADO" },
    ];
    let currentData = [...sampleData]; // Los datos actualmente mostrados/filtrados


    // --- MODAL DE CONFIRMACI√ìN ---
    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
    const modalMessage = document.getElementById('modalMessage');
    let idsToDelete = [];

    function openDeleteModal(ids) {
        idsToDelete = ids;
        modalMessage.textContent = `¬øEst√°s seguro de que quieres eliminar ${ids.length} env√≠o(s) seleccionados? Esta acci√≥n no se puede deshacer.`;
        deleteModal.classList.remove('hidden');
    }

    function closeDeleteModal() {
        idsToDelete = [];
        deleteModal.classList.add('hidden');
    }

    confirmDeleteBtn.addEventListener('click', () => {
        // Filtra el array principal para excluir los IDs a eliminar
        sampleData = sampleData.filter(item => !idsToDelete.includes(item.id));
        showToast(`${idsToDelete.length} env√≠o(s) eliminado(s) permanentemente.`);
        closeDeleteModal();
        aplicarFiltros(); // Refresca la tabla
    });
    
    cancelDeleteBtn.addEventListener('click', closeDeleteModal);


    // --- PANEL DE EDICI√ìN ---
    const editPanel = document.getElementById('editPanel');
    const editPanelOverlay = document.getElementById('editPanelOverlay');
    const closeEditPanelBtn = document.getElementById('closeEditPanel');
    const saveEditBtn = document.getElementById('saveEditBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editForm = document.getElementById('editForm');
    
    function openEditPanel(shipmentId) {
        const shipment = sampleData.find(item => item.id === shipmentId);
        if (!shipment) return;

        // Poblar el formulario
        document.getElementById('editShipmentId').value = shipment.id;
        document.getElementById('editNombre').value = shipment.nombre || '';
        document.getElementById('editCliente').value = shipment.cliente || '';
        document.getElementById('editTelefono').value = shipment.telefono || '';
        document.getElementById('editFechaEnvio').value = shipment.fechaEnvio || '';
        
        // Mostrar/ocultar campos seg√∫n el tipo de courier
        const deliveryFields = document.getElementById('editFieldsDelivery');
        const courierFields = document.getElementById('editFieldsCourier');
        
        if (shipment.tipo === 'DELIVERY') {
            deliveryFields.classList.remove('hidden');
            courierFields.classList.add('hidden');
            document.getElementById('editDistrito').value = shipment.distrito || '';
            document.getElementById('editDireccion').value = shipment.direccion || '';
            document.getElementById('editReferencia').value = shipment.referencia || '';
        } else {
            deliveryFields.classList.add('hidden');
            courierFields.classList.remove('hidden');
            document.getElementById('editDni').value = shipment.dni || '';
            document.getElementById('editAgencia').value = shipment.agencia || '';
        }

        // Mostrar panel y overlay
        editPanelOverlay.classList.remove('hidden');
        editPanel.classList.remove('translate-x-full');
        
        // Deshabilitar el bot√≥n de guardar al abrir
        saveEditBtn.disabled = true;
    }

    function closeEditPanel() {
        editPanel.classList.add('translate-x-full');
        editPanelOverlay.classList.add('hidden');
        editForm.reset(); // Limpia el formulario
    }

    saveEditBtn.addEventListener('click', () => {
        const shipmentId = parseInt(document.getElementById('editShipmentId').value, 10);
        const shipmentIndex = sampleData.findIndex(item => item.id === shipmentId);

        if (shipmentIndex === -1) {
            showToast('Error: No se pudo guardar el env√≠o.');
            return;
        }

        const updatedShipment = { ...sampleData[shipmentIndex] };

        // Actualizar datos comunes
        updatedShipment.nombre = document.getElementById('editNombre').value;
        updatedShipment.telefono = document.getElementById('editTelefono').value;
        updatedShipment.fechaEnvio = document.getElementById('editFechaEnvio').value;
        
        // Actualizar datos condicionales
        if (updatedShipment.tipo === 'DELIVERY') {
            updatedShipment.distrito = document.getElementById('editDistrito').value;
            updatedShipment.direccion = document.getElementById('editDireccion').value;
            updatedShipment.referencia = document.getElementById('editReferencia').value;
        } else {
            updatedShipment.dni = document.getElementById('editDni').value;
            updatedShipment.agencia = document.getElementById('editAgencia').value;
        }

        // Reemplazar el objeto antiguo con el nuevo en el array de datos
        sampleData[shipmentIndex] = updatedShipment;
        
        closeEditPanel();
        aplicarFiltros(); // Refrescar la tabla
        showToast('Env√≠o actualizado con √©xito.');

        // **NUEVO: Feedback Visual Inmediato**
        const updatedRow = tbody.querySelector(`tr[data-id="${shipmentId}"]`);
        if (updatedRow) {
            updatedRow.classList.add('bg-orange-100');
            setTimeout(() => {
                updatedRow.classList.remove('bg-orange-100');
            }, 2500); // El resaltado dura 2.5 segundos
        }
    });

    // Habilitar el bot√≥n de guardar cuando se detecta un cambio en el formulario
    editForm.addEventListener('input', () => {
        saveEditBtn.disabled = false;
    });

    closeEditPanelBtn.addEventListener('click', closeEditPanel);
    cancelEditBtn.addEventListener('click', closeEditPanel);
    editPanelOverlay.addEventListener('click', closeEditPanel);


    // Funci√≥n para obtener los IDs de los env√≠os seleccionados
    function getSelectedIds() {
        return [...tbody.querySelectorAll('.rowCheck:checked')]
            .map(cb => parseInt(cb.closest('tr').dataset.id, 10));
    }

    // Funci√≥n para obtener los env√≠os seleccionados como objetos
    function getSelectedShipments() {
        const selectedIds = getSelectedIds();
        // Usamos filter en sampleData, no currentData, para asegurar obtener los objetos completos originales
        return sampleData.filter(item => selectedIds.includes(item.id));
    }
    
    // Funci√≥n para renderizar la tabla
    function renderTable(data) {
        currentData = data; // Actualiza los datos actuales
        
        // **NUEVO: L√≥gica de Onboarding / Estado Vac√≠o**
        if (data.length === 0) {
            tableContainer.classList.add('hidden');
            emptyStateContainer.classList.remove('hidden');
            return;
        }
        
        tableContainer.classList.remove('hidden');
        emptyStateContainer.classList.add('hidden');
        tbody.innerHTML = '';


        data.forEach(item => {
            const row = document.createElement('tr');
            // **NUEVO: Transici√≥n a√±adida para el feedback visual**
            row.classList.add('hover:bg-orange-50', 'transition-colors', 'duration-1000', 'ease-out', 'cursor-pointer');
            // Almacena informaci√≥n en data attributes para un f√°cil acceso
            row.dataset.id = item.id;
            row.dataset.tipo = item.tipo;
            row.dataset.cliente = item.cliente;
            row.dataset.fechaenvio = item.fechaEnvio;
            
            // Mapeo de estados a clases Tailwind para los badges
            const badgeClassMap = {
                "PENDIENTE": 'bg-amber-100 text-badge-pending border-amber-300',
                "ENVIADO": 'bg-orange-100 text-badge-sent border-orange-300',
                "ENTREGADO": 'bg-emerald-100 text-badge-delivered border-emerald-300',
                "REPROGRAMADO": 'bg-purple-100 text-badge-rescheduled border-purple-300',
            };
            const estadoBadge = `<span class="badge ${badgeClassMap[item.estado]} px-2 py-1 rounded-full text-xs font-bold border">${item.estado}</span>`;

            row.innerHTML = `
                <td class="border-t border-gray-200 p-3"><input type="checkbox" class="rowCheck rounded border-gray-300 text-accent focus:ring-accent" /></td>
                <td class="border-t border-gray-200 p-3 text-xs text-gray-700 nowrap">${item.fechaReg}</td>
                <td class="border-t border-gray-200 p-3 text-xs text-gray-700">${item.cliente}</td>
                <td class="border-t border-gray-200 p-3 text-xs text-gray-700">${item.tipo}</td>
                <td class="border-t border-gray-200 p-3 text-xs text-gray-700">${item.nombre}</td>
                <td class="border-t border-gray-200 p-3 text-xs text-gray-700">${item.telefono}</td>
                <td class="col-distrito border-t border-gray-200 p-3 text-xs text-gray-700">${item.distrito || '-'}</td>
                <td class="col-direccion border-t border-gray-200 p-3 text-xs text-gray-700">${item.direccion || '-'}</td>
                <td class="col-referencia border-t border-gray-200 p-3 text-xs text-gray-700">${item.referencia || '-'}</td>
                <td class="col-dni border-t border-gray-200 p-3 text-xs text-gray-700">${item.dni || '-'}</td>
                <td class="col-agencia border-t border-gray-200 p-3 text-xs text-gray-700">${item.agencia || '-'}</td>
                <td class="border-t border-gray-200 p-3 text-xs text-gray-700 nowrap">${item.fechaEnvio}</td>
                <td class="estado border-t border-gray-200 p-3">${estadoBadge}</td>
                <td class="border-t border-gray-200 p-3 text-center">
                    <a href="#" class="whatsapp-link text-green-500 hover:text-green-700 transition-colors" data-id="${item.id}" title="Enviar resumen por WhatsApp">
                        <i data-feather="send" class="w-5 h-5"></i>
                    </a>
                </td>
            `;
            tbody.appendChild(row);
        });
        // Es importante volver a inicializar los iconos despu√©s de agregarlos din√°micamente
        feather.replace();
    }

    // Funci√≥n principal de filtros y visibilidad de columnas
    function aplicarFiltros() {
        const tipo = filtroTipo.value;
        const cel = filtroCliente.value.trim().toLowerCase();
        const fecha = filtroFecha.value;
        
        // **NUEVO: Simular estado vac√≠o si se quitan todos los datos**
        // Descomenta la siguiente l√≠nea para probar la pantalla de Onboarding
        // const filteredData = []; 
        const filteredData = sampleData.filter(item => {
            const okTipo = !tipo || item.tipo === tipo;
            const okCli = !cel || item.cliente.includes(cel);
            const okFec = !fecha || item.fechaEnvio === fecha;
            return okTipo && okCli && okFec;
        });
        
        // 2. Renderizar la tabla con los datos filtrados
        renderTable(filteredData);
        
        // 3. Ahora, aplicar la visibilidad de columnas a la tabla reci√©n renderizada
        const colDistrito = document.querySelectorAll('.col-distrito');
        const colDireccion = document.querySelectorAll('.col-direccion');
        const colReferencia = document.querySelectorAll('.col-referencia');
        const colDni = document.querySelectorAll('.col-dni');
        const colAgencia = document.querySelectorAll('.col-agencia');

        // Resetear visibilidad
        [...colDistrito, ...colDireccion, ...colReferencia, ...colDni, ...colAgencia].forEach(el => el.style.display = 'table-cell');
        
        // Aplicar reglas de visibilidad seg√∫n Courier
        if (tipo === 'DELIVERY') { 
            [...colDni, ...colAgencia].forEach(el => el.style.display = 'none'); 
        } else if (tipo === 'SHALOM' || tipo === 'OLVA') { 
            [...colDistrito, ...colDireccion, ...colReferencia].forEach(el => el.style.display = 'none'); 
        }

        // 4. Deseleccionar todas las filas
        deseleccionarTodo();
    }

    // Funciones de selecci√≥n en lote
    function contarSeleccionados(){
        const count = tbody.querySelectorAll('.rowCheck:checked').length;
        selCount.textContent = `${count} seleccionados`;
    }
    function seleccionarTodo(checked){
        tbody.querySelectorAll('.rowCheck').forEach(cb => cb.checked = checked);
        thCheckTodos.checked = checked;
        checkTodos.checked = checked;
        contarSeleccionados();
    }
    function deseleccionarTodo(){ seleccionarTodo(false); }

    // Eventos de selecci√≥n
    checkTodos.addEventListener('change', e => seleccionarTodo(e.target.checked));
    thCheckTodos.addEventListener('change', e => seleccionarTodo(e.target.checked));
    
    // Evento unificado en el cuerpo de la tabla para abrir panel de edici√≥n y manejar checkboxes
    tbody.addEventListener('click', e => {
        const target = e.target;
        
        // Si se hace clic en un checkbox, solo contamos los seleccionados
        if (target.classList.contains('rowCheck')) {
            contarSeleccionados();
            return;
        }

        const whatsAppLink = target.closest('.whatsapp-link');
        const row = target.closest('tr');

        // Si se hace clic en el link de WhatsApp, se maneja y se detiene la ejecuci√≥n
        if (whatsAppLink) {
            e.preventDefault();
            const shipmentId = parseInt(whatsAppLink.dataset.id, 10);
            const shipment = sampleData.find(item => item.id === shipmentId);

            if (shipment) {
                const businessName = document.getElementById('businessName').value || 'tu tienda';
                let details = (shipment.tipo === 'DELIVERY') ?
                    `Courier: ${shipment.tipo}\nDistrito: ${shipment.distrito}\nDirecci√≥n: ${shipment.direccion}` :
                    `Courier: ${shipment.tipo}\nAgencia: ${shipment.agencia}\nDNI/CE: ${shipment.dni}`;
                
                const message = `¬°Hola ${shipment.nombre}! üëã Te enviamos los detalles de tu env√≠o con ${businessName}:\n\n${details}\n\nFecha de Env√≠o Programada: ${shipment.fechaEnvio}\n\n¬°Gracias por tu compra! üòä`;
                const whatsappUrl = `https://wa.me/51${shipment.cliente}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }
            return;
        }

        // Si se hizo clic en cualquier otra parte de la fila, abre el panel de edici√≥n
        if (row && row.dataset.id) {
            const shipmentId = parseInt(row.dataset.id, 10);
            openEditPanel(shipmentId);
        }
    });

    // Evento de acci√≥n en lote
    accionLote.addEventListener('change', () => {
        fechaReprog.classList.toggle('oculto', accionLote.value !== 'REPROGRAMADO');
        if (accionLote.value !== 'REPROGRAMADO') fechaReprog.value = '';
    });

    // Evento de aplicar acci√≥n en lote
    btnAplicarLote.addEventListener('click', () => {
        const action = accionLote.value;
        if (!action){ showToast('Elige una acci√≥n en lote'); return; }
        
        const seleccionados = getSelectedIds();
        if (seleccionados.length === 0){ showToast('No hay env√≠os seleccionados'); return; }

        if (action === 'ELIMINAR') {
            openDeleteModal(seleccionados);
            return; // Detiene la ejecuci√≥n aqu√≠, el modal se encargar√° del resto
        }

        if (action === 'REPROGRAMADO' && !fechaReprog.value){ showToast('Selecciona fecha para reprogramar'); return; }
        
        // Actualizar los datos en el array principal (simulando actualizaci√≥n de Firestore)
        seleccionados.forEach(id => {
            const item = sampleData.find(d => d.id === id);
            if (item) {
                if (action === 'REPROGRAMADO') {
                    item.estado = 'REPROGRAMADO';
                    item.fechaEnvio = fechaReprog.value;
                } else {
                    item.estado = action; // Aplica ENVIADO o ENTREGADO
                }
            }
        });

        showToast(`Acci√≥n aplicada a ${seleccionados.length} env√≠o(s)`);
        
        // Refrescar la tabla para mostrar los cambios
        aplicarFiltros();
    });

    btnAplicarFiltros.addEventListener('click', aplicarFiltros);

    // --- FUNCIONALIDADES DE PLANTILLAS Y ETIQUETAS ---

    /**
     * @param {string} fileName Nombre del archivo a descargar
     * @param {string} data Contenido del archivo (ya en formato CSV/texto)
     */
    function downloadCSV(fileName, data) {
        // Se a√±ade el BOM (Byte Order Mark) para UTF-8. Crucial para que Excel
        // abra el archivo CSV correctamente con caracteres especiales (acentos, √±).
        const BOM = '\uFEFF'; 
        const csvWithBOM = BOM + data;

        // El tipo MIME se mantiene como CSV para compatibilidad.
        const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        // El nombre del archivo ahora USA .csv
        link.setAttribute('download', fileName); 
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    /**
     * Funci√≥n para "limpiar" un valor antes de exportarlo al CSV.
     * Reemplaza comillas dobles con un espacio para evitar problemas de formato.
     * @param {string} value El valor de la celda.
     * @returns {string} El valor sanitizado.
     */
    function sanitizeValue(value) {
        if (value === null || value === undefined) return '';
        // Convierte a string y reemplaza cualquier comilla doble interna con un espacio
        return String(value).replace(/"/g, ' '); 
    }


    /**
     * Genera el contenido CSV para un courier espec√≠fico.
     * @param {string} courier 'SHALOM', 'OLVA' o 'DELIVERY'
     * @param {Array<Object>} shipments Lista de env√≠os seleccionados
     */
    function generateCourierCSV(courier, shipments) {
        // Filtra solo los env√≠os que son del tipo de courier solicitado
        const filteredShipments = shipments.filter(s => s.tipo === courier);

        if (filteredShipments.length === 0) {
            showToast(`No se encontraron env√≠os de ${courier} seleccionados para exportar.`);
            return;
        }

        let csvContent = '';
        let fileName = '';

        // --- DEFINIMOS EL DELIMITADOR: Punto y coma (;) para mayor compatibilidad con Excel en Latinoam√©rica ---
        const DELIMITER = ';'; 

        if (courier === 'SHALOM' || courier === 'OLVA') {
            fileName = `${courier.toLowerCase()}_plantilla_${new Date().toISOString().slice(0, 10)}.csv`; 
            
            // Usamos el DELIMITER para el encabezado
            csvContent = `FechaEnvio${DELIMITER}NombreDestinatario${DELIMITER}Telefono${DELIMITER}DNI_CE${DELIMITER}Agencia_Recojo\n`; 
            
            filteredShipments.forEach(item => {
                const row = [
                    sanitizeValue(item.fechaEnvio),
                    sanitizeValue(item.nombre),
                    sanitizeValue(item.telefono),
                    sanitizeValue(item.dni),
                    sanitizeValue(item.agencia)
                ];
                // Usamos el DELIMITER para unir los campos
                csvContent += row.join(DELIMITER) + '\n';
            });
        } 
        
        else if (courier === 'DELIVERY') {
            fileName = `delivery_propio_plantilla_${new Date().toISOString().slice(0, 10)}.csv`;
            
            // Encabezado para Delivery Propio (usando Distrito y Direcci√≥n)
            csvContent = `FechaEnvio${DELIMITER}NombreDestinatario${DELIMITER}Celular${DELIMITER}Distrito${DELIMITER}Direccion${DELIMITER}Referencia\n`;
            
            filteredShipments.forEach(item => {
                const row = [
                    sanitizeValue(item.fechaEnvio),
                    sanitizeValue(item.nombre),
                    sanitizeValue(item.cliente), // Usamos 'cliente' que contiene el n√∫mero de celular
                    sanitizeValue(item.distrito),
                    sanitizeValue(item.direccion),
                    sanitizeValue(item.referencia)
                ];
                // Usamos el DELIMITER para unir los campos
                csvContent += row.join(DELIMITER) + '\n';
            });
        }
        
        // Si hay contenido, proceder a la descarga
        if (csvContent) {
            downloadCSV(fileName, csvContent);
            showToast(`Plantilla ${courier} generada con ${filteredShipments.length} env√≠o(s).`);
        }
    }

    // Eventos de botones de plantillas
    btnTplDelivery.addEventListener('click', () => { // Nuevo evento
        const selected = getSelectedShipments();
        if (selected.length === 0) { showToast('Selecciona env√≠os de tipo DELIVERY para exportar.'); return; }
        generateCourierCSV('DELIVERY', selected);
    });
    
    btnTplShalom.addEventListener('click', () => {
        const selected = getSelectedShipments();
        if (selected.length === 0) { showToast('Selecciona env√≠os de tipo SHALOM para exportar.'); return; }
        generateCourierCSV('SHALOM', selected);
    });

    btnTplOlva.addEventListener('click', () => {
        const selected = getSelectedShipments();
        if (selected.length === 0) { showToast('Selecciona env√≠os de tipo OLVA para exportar.'); return; }
        generateCourierCSV('OLVA', selected);
    });

    // Funci√≥n para imprimir etiquetas
    btnEtiquetas.addEventListener('click', () => {
        const shipments = getSelectedShipments();
        if (shipments.length === 0) {
            showToast('Selecciona al menos un env√≠o para imprimir etiquetas.');
            return;
        }

        // Genera el HTML para las etiquetas
        let labelsHtml = shipments.map((item, index) => {
            const isDelivery = item.tipo === 'DELIVERY';
            const location = isDelivery ? 
                `<strong>Distrito:</strong> ${item.distrito}<br><strong>Direcci√≥n:</strong> ${item.direccion}<br><strong>Ref:</strong> ${item.referencia || ''}` :
                `<strong>Agencia:</strong> ${item.agencia}<br><strong>DNI/CE:</strong> ${item.dni}`;

            return `
                <div class="label-card">
                    <div class="label-header">
                        ETIQUETA ${index + 1}/${shipments.length} | ${item.tipo}
                    </div>
                    <div class="label-info">
                        <p><strong>Remitente:</strong> ${businessName}</p>
                        <p><strong>Destinatario:</strong> ${item.nombre} (${item.telefono})</p>
                        <p><strong>Cliente:</strong> ${item.cliente}</p>
                        <p><strong>Fecha Env√≠o:</strong> ${item.fechaEnvio}</p>
                        <p>${location}</p>
                    </div>
                    <div class="qr-placeholder">
                        [C√≥digo de Rastreo ${item.id} / QR Placeholder]
                    </div>
                </div>
            `;
        }).join('');

        const printWindow = window.open('', 'PrintLabels', 'height=600,width=800');
        
        // Estructura m√≠nima para la ventana de impresi√≥n, incluyendo los estilos CSS
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Impresi√≥n de Etiquetas</title>
                <style>
                    /* Estilos para el contenedor de impresi√≥n */
                    .print-container { 
                        width: 100%;
                        column-count: 2; 
                        column-gap: 1.5cm;
                        padding: 1cm;
                        box-sizing: border-box;
                    }
                    /* Estilos de la tarjeta de etiqueta */
                    .label-card {
                        break-inside: avoid-column; 
                        page-break-inside: avoid;
                        margin-bottom: 1.5cm; 
                        border: 1px solid #000;
                        padding: 10px;
                        width: 100%;
                        box-sizing: border-box;
                    }
                    .label-header {
                        font-size: 14px;
                        font-weight: bold;
                        border-bottom: 1px dashed #000;
                        padding-bottom: 5px;
                        margin-bottom: 5px;
                    }
                    .label-info {
                        font-size: 12px;
                        margin-top: 5px;
                    }
                    .qr-placeholder {
                        text-align: center;
                        margin-top: 10px;
                        font-size: 10px;
                        border: 1px solid #ccc;
                        padding: 5px;
                        height: 50px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                </style>
            </head>
            <body>
                <div class="print-container">
                    ${labelsHtml}
                </div>
                <script>
                    // Espera a que el contenido se cargue antes de imprimir
                    window.onload = function() {
                        window.print();
                        window.close();
                    };
                <\/script>
            </body>
            </html>
        `);
        printWindow.document.close();
        showToast('Ventana de impresi√≥n de etiquetas abierta.');
    });


    // --- SECCI√ìN LINK M√ÅGICO ---
    const btnCopiarLink = document.getElementById('btnCopiarLink');
    const linkUnicoInput = document.getElementById('linkUnicoInput');
    
    // Uso de navigator.clipboard.writeText para copiar
    btnCopiarLink.addEventListener('click', () => {
        // Fallback for secure context (Canvas environment)
        if (!navigator.clipboard || !navigator.clipboard.writeText) {
            // Fallback for non-secure or restricted contexts
            const textarea = document.createElement('textarea');
            textarea.value = linkUnicoInput.value;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('¬°Enlace copiado al portapapeles!');
            } catch (err) {
                showToast('Error al copiar: Tu navegador no lo permite.');
            }
            document.body.removeChild(textarea);

        } else {
            // Modern Clipboard API
            navigator.clipboard.writeText(linkUnicoInput.value).then(() => {
                showToast('¬°Enlace copiado al portapapeles!');
            }).catch(err => {
                showToast('Error al copiar el enlace.');
            });
        }
    });

    // --- SECCI√ìN MI CUENTA ---
    const businessNameInput = document.getElementById('businessName');
    const headerBusinessName = document.getElementById('headerBusinessName');
    const logoInput = document.getElementById('logoInput');
    const logoPreview = document.getElementById('logoPreview');
    const headerLogo = document.getElementById('headerLogo');
    const btnGuardarConfig = document.getElementById('btnGuardarConfig');

    // Inicializa el nombre del negocio en el encabezado
    headerBusinessName.textContent = businessNameInput.value || '[Nombre del emprendimiento]';
    
    // Actualiza el nombre del negocio en el encabezado
    businessNameInput.addEventListener('input', () => {
        headerBusinessName.textContent = businessNameInput.value || '[Nombre del emprendimiento]';
    });

    // Vista previa y actualizaci√≥n del logo
    logoInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                // Mostrar en la vista previa
                logoPreview.src = imageUrl;
                logoPreview.classList.remove('hidden');
                // Mostrar en el encabezado
                headerLogo.src = imageUrl;
                headerLogo.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            logoPreview.classList.add('hidden');
            headerLogo.classList.add('hidden');
        }
    });

    // Evento de guardar configuraci√≥n (simulado)
    btnGuardarConfig.addEventListener('click', () => {
        showToast('Configuraci√≥n guardada exitosamente.');
        // Aqu√≠ ir√≠a la l√≥gica para guardar los datos en el backend (Firestore).
    });

    // **NUEVO: Bot√≥n de Onboarding para ir a 'Mi Cuenta'**
    goToAccountBtn.addEventListener('click', () => {
        // Simula un clic en el enlace de navegaci√≥n de 'Mi Cuenta'
        const accountNavLink = document.querySelector('a.nav-link[href="#cuenta"]');
        if(accountNavLink) {
            accountNavLink.click();
        }
    });


    // --- UTILIDADES ---
    const toast = document.getElementById('toast');
    let toastTimeout;
    function showToast(msg){
        clearTimeout(toastTimeout);
        toast.textContent = msg;
        toast.classList.remove('opacity-0', 'translate-y-2');
        toast.classList.add('opacity-100', 'translate-y-0');
        
        toastTimeout = setTimeout(() => {
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0', 'translate-y-2');
        }, 2500);
    }

    // --- INICIALIZACI√ìN ---
    aplicarFiltros();
    contarSeleccionados(); // Inicializa el estado de los botones
});
</script>
</body>
</html>
